# Диаграмма развертывания системы учёта дефектов

## Обзор
Диаграмма показывает физическое развертывание системы: устройства пользователей, локальный дата-центр завода с Kubernetes кластером и интеграции с внешними системами.

## Слой пользователей (User Devices)

**Mechanic Tablet (PWA)** - планшеты ремонтников работают как Progressive Web App с поддержкой оффлайн-кэша на короткие сбои сети.

**Workstations (Web)** - рабочие станции для бригадира, диспетчера, инженера QC, начальника цеха, бухгалтера и администратора.

Все клиенты подключаются через HTTPS (REST API) и WSS (WebSocket для реал-тайм обновлений).

## Plant Data Center (On-Premises)

### Kubernetes Cluster
Основная инфраструктура развертывания:

**Ingress / Gateway узел:**
- API Gateway / BFF (Docker) - точка входа, TLS-терминация, маршрутизация, WAF, rate limiting
- Realtime Gateway (Docker) - WebSocket и Server-Sent Events для реал-тайм обновлений

**Application Nodes - 8 микросервисов:**
- IAM (AuthN/AuthZ) - управление доступом и аутентификацией
- Defect Service - работа с дефектами
- Repair Service - управление ремонтами
- Resources Service - данные о зонах, местах, бригадах, сменах
- Reporting & Analytics - генерация отчётов
- Notification Service - отправка оповещений
- Integration Adapter - синхронизация с MES/ERP/HR
- Web SPA (static) - статические файлы фронтенда

### Хранилища данных

**PostgreSQL (HA)** - основная реляционная база данных OLTP с высокой доступностью, индексами на VIN, смены, зоны, временные метки.

**Redis** - кэширование: статус ремонтных мест, свободные рабочие, сессии пользователей.

**Kafka/RabbitMQ** - message broker для асинхронной доставки доменных событий (DefectCreated, RepairStarted, RepairFinished и т.д.).

**MinIO / S3-compatible** - объектное хранилище для фотографий дефектов, диаграмм и документов с версионированием и политиками жизненного цикла.

**ClickHouse / OLAP** - колоночное хранилище для агрегации и аналитики по сменам и месяцам, разгружает OLTP.

### Мониторинг и наблюдаемость

**Observability (Prometheus/Grafana/ELK)** - сбор метрик, логов и трейсов для мониторинга здоровья системы и отладки проблем.

## External Systems (Corporate / External)

**MES / ERP** - производственная система и система планирования ресурсов. Интеграция через защищённые каналы (VPN/приватные линии).

**HR / Shifts** - синхронизация данных о сотрудниках и расписании смен.

**Email / SMS Provider** - отправка уведомлений пользователям.

Адаптер интеграции изолирует различия протоколов и форматов данных.

## Ключевые потоки данных

- Планшеты и рабочие станции -> API Gateway (HTTPS)
- Клиенты -> Realtime Gateway (WSS для реал-тайм)
- API -> все микросервисы
- Сервисы -> PostgreSQL (основная БД)
- Repair Service, Resources Service -> Redis (быстрый доступ)
- Defect Service -> MinIO (приложения)
- Reporting Service -> ClickHouse (аналитика)
- Все сервисы -> Message Broker (асинхронные события)
- Все компоненты -> Observability (мониторинг)

## Архитектурные особенности

- **Kubernetes** - оркестрация контейнеров, автомасштабирование, саморепарация
- **HA для БД** - высокая доступность PostgreSQL для гарантии стабильности
- **Разделение OLTP/OLAP** - PostgreSQL для операций, ClickHouse для аналитики
- **Event-driven** - message broker для развязки сервисов и надёжной доставки событий
- **Безопасность** - HTTPS, WSS, приватные каналы к внешним системам
- **Наблюдаемость** - полный мониторинг для быстрого обнаружения и разрешения проблем
